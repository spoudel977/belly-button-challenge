// app.js — Belly Button Biodiversity (refined, responsive, polished)

// ---------- Config / Theme ----------
const PLOT_CONFIG = { responsive: true, displayModeBar: false };
const THEME = {
  font: {
    family: "Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif",
    size: 12,
    color: "#2d2d2d",
  },
  paper_bgcolor: "rgba(0,0,0,0)", // transparent so cards own the background
  plot_bgcolor: "#ffffff",
};

// Global for dropdown onchange in HTML
let DATA = null;
window.optionChanged = (val) => updateCharts(val);

// ---------- Load data once ----------
d3.json("https://static.bc-edx.com/data/dl-1-2/m14/lms/starter/samples.json")
  .then((response) => {
    DATA = response;

    // populate dropdown
    const dropdown = d3.select("#selDataset");
    response.names.forEach((id) => dropdown.append("option").text(id).property("value", id));

    // default selection
    const initial = response.names[0];
    updateCharts(initial);

    // sync dropdown change (in case HTML's inline handler isn't used)
    dropdown.on("change", function () {
      updateCharts(dropdown.property("value"));
    });

    // responsive resize
    window.addEventListener("resize", () => {
      ["bar", "bubble", "gauge"].forEach((id) => {
        const el = document.getElementById(id);
        if (el) Plotly.Plots.resize(el);
      });
    });
  })
  .catch((err) => {
    console.error("Error loading samples.json:", err);
    d3.select("#sample-metadata").html(
      `<div class="text-danger">Failed to load data.</div>`
    );
  });

// ---------- Main update ----------
function updateCharts(selectedId) {
  if (!DATA) return;

  const sample = DATA.samples.find((s) => s.id === selectedId);
  const metadata = DATA.metadata.find((m) => m.id === parseInt(selectedId, 10));

  if (!sample || !metadata) return;

  renderMetadata(metadata);
  renderBar(sample);
  renderBubble(sample);
  renderGauge(metadata.wfreq);
}

// ---------- Panels / Charts ----------
function renderMetadata(meta) {
  const panel = d3.select("#sample-metadata");
  panel.html("");

  const table = panel.append("table").attr("class", "table table-sm mb-0");
  const tbody = table.append("tbody");

  Object.entries(meta).forEach(([k, v]) => {
    const row = tbody.append("tr");
    row.append("th").attr("scope", "row").style("width", "45%").text(formatKey(k));
    row.append("td").text(v ?? "—");
  });
}

function renderBar(sample) {
  // top 10
  const top10 = sample.sample_values
    .map((val, i) => ({ val, id: sample.otu_ids[i], label: sample.otu_labels[i] }))
    .sort((a, b) => b.val - a.val)
    .slice(0, 10)
    .reverse();

  const trace = {
    x: top10.map((d) => d.val),
    y: top10.map((d) => `OTU ${d.id}`),
    text: top10.map((d) => d.label),
    type: "bar",
    orientation: "h",
    marker: { color: "#2266cc" },
    hovertemplate: "%{y}<br>Value: %{x}<extra></extra>",
  };

  const layout = {
    ...THEME,
    margin: { t: 10, r: 10, b: 40, l: 70 },
    xaxis: { title: "Sample Values", gridcolor: "#f0f0f0", zeroline: false, automargin: true },
    yaxis: { title: "OTU IDs", gridcolor: "#ffffff", automargin: true },
  };

  Plotly.react("bar", [trace], layout, PLOT_CONFIG);
}

function renderBubble(sample) {
  const x = sample.otu_ids;
  const y = sample.sample_values;
  const labels = sample.otu_labels;

  // scale bubble sizes pleasantly
  const maxVal = Math.max(...y);
  const sizeref = maxVal ? maxVal / 70 : 1;

  const trace = {
    x,
    y,
    text: labels,
    mode: "markers",
    marker: {
      size: y,
      sizemode: "area",
      sizeref,
      color: x,
      colorscale: "Viridis",
      showscale: true,
      opacity: 0.85,
      line: { width: 0.5, color: "rgba(0,0,0,0.15)" },
      colorbar: { thickness: 12, outlinewidth: 0 },
    },
    hovertemplate: "OTU %{x}<br>Value: %{y}<extra></extra>",
  };

  const layout = {
    ...THEME,
    margin: { t: 10, r: 20, b: 50, l: 60 },
    xaxis: { title: "OTU IDs", gridcolor: "#f0f0f0", zeroline: false, automargin: true },
    yaxis: { title: "Sample Values", gridcolor: "#f0f0f0", zeroline: false, automargin: true },
  };

  Plotly.react("bubble", [trace], layout, PLOT_CONFIG);
}

function renderGauge(wfreqRaw) {
  const wfreq = Number.isFinite(wfreqRaw) ? wfreqRaw : 0;

  const data = [
    {
      type: "indicator",
      mode: "gauge+number",
      value: wfreq,
      number: { font: { size: 20 } },
      gauge: {
        axis: { range: [0, 9], tickwidth: 1, tickcolor: "#708090" },
        bar: { color: "#2266cc" },
        bgcolor: "#ffffff",
        borderwidth: 0,
        steps: [
          { range: [0, 3], color: "#e8f5e9" },
          { range: [3, 6], color: "#c8e6c9" },
          { range: [6, 9], color: "#a5d6a7" },
        ],
        threshold: { line: { color: "#d32f2f", width: 3 }, thickness: 0.75, value: wfreq },
      },
      domain: { x: [0, 1], y: [0, 1] },
    },
  ];

  const layout = {
    ...THEME,
    margin: { t: 10, r: 10, b: 20, l: 10 },
  };

  Plotly.react("gauge", data, layout, PLOT_CONFIG);
}

// ---------- Helpers ----------
function formatKey(k) {
  // convert snake_case / short keys to nicer labels
  const map = {
    id: "ID",
    ethnicity: "Ethnicity",
    gender: "Gender",
    age: "Age",
    location: "Location",
    bbtype: "BB Type",
    wfreq: "Wash Freq (wk)",
  };
  if (map[k]) return map[k];
  // generic pretty label
  return k.replace(/_/g, " ").replace(/\b\w/g, (c) => c.toUpperCase());
}
